{% extends "base.html" %}

{% block title %}Preview Import Data{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1 class="display-4">Preview Import Data</h1>
        <p class="lead">Review the data before importing</p>
    </div>
</div>

<!-- Errors Section -->
{% if errors %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-danger">
            <h5><i class="bi bi-exclamation-octagon"></i> Errors Found ({{ errors|length }})</h5>
            <p class="mb-2">The following errors must be fixed before importing:</p>
            <ul class="mb-0">
                {% for error in errors %}
                <li>{{ error }}</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>
{% endif %}

<!-- Warnings Section -->
{% if warnings %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-warning">
            <h5><i class="bi bi-exclamation-triangle"></i> Warnings ({{ warnings|length }})</h5>
            <ul class="mb-0">
                {% for warning in warnings %}
                <li>{{ warning }}</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>
{% endif %}

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-6 mb-3">
        <div class="card text-white bg-primary h-100">
            <div class="card-body text-center">
                <h5 class="card-title"><i class="bi bi-truck"></i> Vehicles to Import</h5>
                <h2 class="mb-0">{{ vehicles|length }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-3">
        <div class="card text-white bg-success h-100">
            <div class="card-body text-center">
                <h5 class="card-title"><i class="bi bi-wrench"></i> Maintenance Records</h5>
                <h2 class="mb-0">{{ maintenance|length }}</h2>
            </div>
        </div>
    </div>
</div>

<!-- Vehicles Preview -->
{% if vehicles %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-truck"></i> Vehicles ({{ vehicles|length }})</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>VIN</th>
                                <th>Year</th>
                                <th>Make</th>
                                <th>Model</th>
                                <th>License Plate</th>
                                <th>Purchase Date</th>
                                <th>Mileage</th>
                                <th>Status</th>
                                <th>Driver</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for v in vehicles %}
                            <tr>
                                <td><code>{{ v.vin }}</code></td>
                                <td>{{ v.year }}</td>
                                <td>{{ v.make }}</td>
                                <td>{{ v.model }}</td>
                                <td><strong>{{ v.license_plate }}</strong></td>
                                <td>{{ v.purchase_date }}</td>
                                <td>{{ "{:,}".format(v.current_mileage) }}</td>
                                <td>
                                    {% if v.status == 'Active' %}
                                    <span class="badge bg-success">{{ v.status }}</span>
                                    {% elif v.status == 'In Maintenance' %}
                                    <span class="badge bg-warning text-dark">{{ v.status }}</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ v.status }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ v.assigned_driver or '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Maintenance Records Preview -->
{% if maintenance %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-wrench"></i> Maintenance Records ({{ maintenance|length }})</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Vehicle VIN</th>
                                <th>Type</th>
                                <th>Service Date</th>
                                <th>Mileage</th>
                                <th>Cost</th>
                                <th>Provider</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for m in maintenance %}
                            <tr>
                                <td><code>{{ m.vehicle_vin[:8] }}...{{ m.vehicle_vin[-4:] }}</code></td>
                                <td><span class="badge bg-secondary">{{ m.maintenance_type }}</span></td>
                                <td>{{ m.service_date }}</td>
                                <td>{{ "{:,}".format(m.mileage_at_service) }}</td>
                                <td>${{ "%.2f"|format(m.cost) }}</td>
                                <td>{{ m.service_provider or '-' }}</td>
                                <td>{{ (m.notes[:30] + '...') if m.notes and m.notes|length > 30 else (m.notes or '-') }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Action Buttons -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                {% if errors %}
                <div class="alert alert-danger mb-3">
                    <i class="bi bi-exclamation-octagon"></i>
                    <strong>Cannot import:</strong> Please fix the errors above and upload the file again.
                </div>
                <a href="{{ url_for('import_data_page') }}" class="btn btn-primary btn-lg">
                    <i class="bi bi-arrow-left"></i> Go Back & Fix Errors
                </a>
                {% elif vehicles|length == 0 and maintenance|length == 0 %}
                <div class="alert alert-warning mb-3">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>No data to import:</strong> The file appears to be empty or only contains example data.
                </div>
                <a href="{{ url_for('import_data_page') }}" class="btn btn-primary btn-lg">
                    <i class="bi bi-arrow-left"></i> Go Back
                </a>
                {% else %}
                <form action="{{ url_for('confirm_import') }}" method="POST" class="d-inline">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="clear_existing" name="clear_existing" value="yes">
                        <label class="form-check-label text-danger" for="clear_existing">
                            <strong><i class="bi bi-exclamation-triangle"></i> Clear ALL existing data before import</strong>
                            <br><small class="text-muted">Warning: This will permanently delete all current vehicles and maintenance records!</small>
                        </label>
                    </div>
                    
                    <button type="submit" class="btn btn-success btn-lg me-2">
                        <i class="bi bi-check-circle"></i> Confirm Import
                    </button>
                    <a href="{{ url_for('import_data_page') }}" class="btn btn-secondary btn-lg">
                        <i class="bi bi-x-circle"></i> Cancel
                    </a>
                </form>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
